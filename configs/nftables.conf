#!/usr/sbin/nft -f

# nftables configuration for OpenStick (Debian 13)
# - NAT (IPv4/IPv6) for LAN 192.168.100.0/24 and dead:beef::/64
# - Redirect all DNS from LAN (br0) to local resolver on port 53

flush ruleset

# NAT for IPv4
table ip nat {
	chain prerouting {
		type nat hook prerouting priority -100;
		# Prevent DNS leaks: redirect all DNS from LAN to local :53
		iif "br0" udp dport 53 redirect to :53
		iif "br0" tcp dport 53 redirect to :53
	}

	chain postrouting {
		type nat hook postrouting priority 100;
		# Masquerade traffic originating from the LAN going outside the LAN
		ip saddr 192.168.100.0/24 ip daddr != 192.168.100.0/24 masquerade
	}
}

# NAT for IPv6
table ip6 nat {
	chain prerouting {
		type nat hook prerouting priority -100;
		# Prevent DNS leaks: redirect all DNS from LAN to local :53
		iif "br0" udp dport 53 redirect to :53
		iif "br0" tcp dport 53 redirect to :53
	}

	chain postrouting {
		type nat hook postrouting priority 100;
		# Masquerade traffic originating from the LAN going outside the LAN
		ip6 saddr dead:beef::/64 ip6 daddr != dead:beef::/64 masquerade
	}
}

# Keep default filter policy (accept) unless a tighter policy is desired.
